#!/usr/bin/env bash
# shellcheck disable=SC2016,SC2155
#
# Update readme
#
# This script should be executed after each successful test-all run
#

set -eu

export MANJARO_PACKAGES_RUN="$(sed -e '/^##/d' -e '/^$/d' packages-run-manjaro.versions 2>/dev/null)"
export MANJARO_PACKAGES_OPT="$(sed -e '/^##/d' -e '/^$/d' packages-opt-manjaro.versions 2>/dev/null)"
export MANJARO_PACKAGES_DEV="$(sed -e '/^##/d' -e '/^$/d' packages-dev-manjaro.versions 2>/dev/null)"
readonly MANJARO_VARS="${MANJARO_PACKAGES_RUN:+"\${MANJARO_PACKAGES_RUN} \${MANJARO_PACKAGES_OPT} \${MANJARO_PACKAGES_DEV}"}"

export UBUNTU_PACKAGES_RUN="$(sed -e '/^##/d' -e '/^$/d' packages-run-ubuntu.versions 2>/dev/null)"
export UBUNTU_PACKAGES_OPT="$(sed -e '/^##/d' -e '/^$/d' packages-opt-ubuntu.versions 2>/dev/null)"
export UBUNTU_PACKAGES_DEV="$(sed -e '/^##/d' -e '/^$/d' packages-dev-ubuntu.versions 2>/dev/null)"
readonly UBUNTU_VARS="${UBUNTU_PACKAGES_RUN:+"\${UBUNTU_PACKAGES_RUN} \${UBUNTU_PACKAGES_OPT} \${UBUNTU_PACKAGES_DEV}"}"

export YDF_HELP="$(./src/usr/bin/ydf --help)"

{
  echo '<!-- DO NOT EDIT THIS FILE; IT WAS GENERATED BY ./tools/update-readme -->'
  echo '<!-- EDIT README.md.tpl INSTEAD -->'

  envsubst "${MANJARO_VARS} ${UBUNTU_VARS} \${YDF_HELP}" <README.md.tpl
} >README.md

echo '>> README.md was generated successfully, review the changes and commit them'
